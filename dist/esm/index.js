import e,{useState as t,useMemo as r}from"react";import{withJsonFormsControlProps as n,useJsonForms as i}from"@jsonforms/react";import{rankWith as a,and as o,uiTypeIs as s}from"@jsonforms/core";import{TextField as c,FormControl as l,InputLabel as p,Select as u,MenuItem as y,TableContainer as f,Paper as h,Table as m,TableHead as d,TableRow as v,TableCell as g,TableBody as b}from"@material-ui/core";const k=({source:r,targetEnum:n,onChange:i})=>{const[a,o]=t("");return e.createElement("div",{style:{display:"flex",marginBottom:"20px"}},e.createElement(c,{label:r?.label||r.value,variant:"outlined","aria-readonly":"true",disabled:!0,style:{marginRight:"40px",width:"100%"}}),e.createElement(l,{variant:"outlined",style:{width:"100%"}},e.createElement(p,null,"Select a Property"),e.createElement(u,{label:"Select a Property",value:a,onChange:e=>{o(e.target.value);const t=n.find((t=>t.value===e.target.value));t&&i(r.value,t)}},n.map((t=>e.createElement(y,{key:t.value,value:t.value},t?.label||t.value))))))},E={tester:a(3,o(s("Dynamic"))),renderer:n((({data:t,handleChange:r,path:n,...i})=>{const a=i.schema,o=(e,i)=>{const a=t.findIndex((t=>t.source.value===e));t[a]={...t[a],target:i},r(n,t)};return e.createElement("div",{style:{width:"1100px",margin:"0 auto"}},e.createElement("div",{style:{display:"flex"}},e.createElement("h2",{style:{marginRight:"auto"}},a.items.properties.source.title),e.createElement("h2",null,a.items.properties.target.title)),a.items.properties.source.enum.map((t=>e.createElement(k,{key:t.value,source:t,targetEnum:a.items.properties.target.enum,onChange:o}))))}))};function j(e,t){var r,n;if("function"==typeof t)void 0!==(n=t(e))&&(e=n);else if(Array.isArray(t))for(r=0;r<t.length;r++)void 0!==(n=t[r](e))&&(e=n);return e}function A(e,t){return"-"===e[0]&&Array.isArray(t)&&/^-\d+$/.test(e)?t.length+parseInt(e,10):e}function O(e){return"[object Object]"===Object.prototype.toString.call(e)}function w(e){return Object(e)===e}function x(e){return 0===Object.keys(e).length}var _=["__proto__","prototype","constructor"],T=function(e){return-1===_.indexOf(e)};function S(e,t){e.indexOf("[")>=0&&(e=e.replace(/\[/g,t).replace(/]/g,""));var r=e.split(t);if(r.filter(T).length!==r.length)throw Error("Refusing to update blacklisted property "+e);return r}var B=Object.prototype.hasOwnProperty;function K(e,t,r,n){if(!(this instanceof K))return new K(e,t,r,n);void 0===t&&(t=!1),void 0===r&&(r=!0),void 0===n&&(n=!0),this.separator=e||".",this.override=t,this.useArray=r,this.useBrackets=n,this.keepArray=!1,this.cleanup=[]}var D=new K(".",!1,!0,!0);function P(e){return function(){return D[e].apply(D,arguments)}}K.prototype._fill=function(e,t,r,n){var i=e.shift();if(e.length>0){if(t[i]=t[i]||(this.useArray&&function(e){return/^\d+$/.test(e)}(e[0])?[]:{}),!w(t[i])){if(!this.override){if(!w(r)||!x(r))throw new Error("Trying to redefine `"+i+"` which is a "+typeof t[i]);return}t[i]={}}this._fill(e,t[i],r,n)}else{if(!this.override&&w(t[i])&&!x(t[i])){if(!w(r)||!x(r))throw new Error("Trying to redefine non-empty obj['"+i+"']");return}t[i]=j(r,n)}},K.prototype.object=function(e,t){var r=this;return Object.keys(e).forEach((function(n){var i=void 0===t?null:t[n],a=S(n,r.separator).join(r.separator);-1!==a.indexOf(r.separator)?(r._fill(a.split(r.separator),e,e[n],i),delete e[n]):e[n]=j(e[n],i)})),e},K.prototype.str=function(e,t,r,n){var i=S(e,this.separator).join(this.separator);return-1!==e.indexOf(this.separator)?this._fill(i.split(this.separator),r,t,n):r[e]=j(t,n),r},K.prototype.pick=function(e,t,r,n){var i,a,o,s,c;for(a=S(e,this.separator),i=0;i<a.length;i++){if(s=A(a[i],t),!t||"object"!=typeof t||!(s in t))return;if(i===a.length-1)return r?(o=t[s],n&&Array.isArray(t)?t.splice(s,1):delete t[s],Array.isArray(t)&&(c=a.slice(0,-1).join("."),-1===this.cleanup.indexOf(c)&&this.cleanup.push(c)),o):t[s];t=t[s]}return r&&Array.isArray(t)&&(t=t.filter((function(e){return void 0!==e}))),t},K.prototype.delete=function(e,t){return this.remove(e,t,!0)},K.prototype.remove=function(e,t,r){var n;if(this.cleanup=[],Array.isArray(e)){for(n=0;n<e.length;n++)this.pick(e[n],t,!0,r);return r||this._cleanup(t),t}return this.pick(e,t,!0,r)},K.prototype._cleanup=function(e){var t,r,n,i;if(this.cleanup.length){for(r=0;r<this.cleanup.length;r++)t=(t=(i=(n=this.cleanup[r].split(".")).splice(0,-1).join("."))?this.pick(i,e):e)[n[0]].filter((function(e){return void 0!==e})),this.set(this.cleanup[r],t,e);this.cleanup=[]}},K.prototype.del=K.prototype.remove,K.prototype.move=function(e,t,r,n,i){return"function"==typeof n||Array.isArray(n)?this.set(t,j(this.pick(e,r,!0),n),r,i):(i=n,this.set(t,this.pick(e,r,!0),r,i)),r},K.prototype.transfer=function(e,t,r,n,i,a){return"function"==typeof i||Array.isArray(i)?this.set(t,j(this.pick(e,r,!0),i),n,a):(a=i,this.set(t,this.pick(e,r,!0),n,a)),n},K.prototype.copy=function(e,t,r,n,i,a){return"function"==typeof i||Array.isArray(i)?this.set(t,j(JSON.parse(JSON.stringify(this.pick(e,r,!1))),i),n,a):(a=i,this.set(t,this.pick(e,r,!1),n,a)),n},K.prototype.set=function(e,t,r,n){var i,a,o,s;if(void 0===t)return r;for(o=S(e,this.separator),i=0;i<o.length;i++){if(s=o[i],i===o.length-1)if(n&&O(t)&&O(r[s]))for(a in t)B.call(t,a)&&(r[s][a]=t[a]);else if(n&&Array.isArray(r[s])&&Array.isArray(t))for(var c=0;c<t.length;c++)r[o[i]].push(t[c]);else r[s]=t;else B.call(r,s)&&(O(r[s])||Array.isArray(r[s]))||(/^\d+$/.test(o[i+1])?r[s]=[]:r[s]={});r=r[s]}return r},K.prototype.transform=function(e,t,r){return t=t||{},r=r||{},Object.keys(e).forEach(function(n){this.set(e[n],this.pick(n,t),r)}.bind(this)),r},K.prototype.dot=function(e,t,r){t=t||{},r=r||[];var n=Array.isArray(e);return Object.keys(e).forEach(function(i){var a=n&&this.useBrackets?"["+i+"]":i;if(w(e[i])&&(O(e[i])&&!x(e[i])||Array.isArray(e[i])&&!this.keepArray&&0!==e[i].length)){if(n&&this.useBrackets){var o=r[r.length-1]||"";return this.dot(e[i],t,r.slice(0,-1).concat(o+a))}return this.dot(e[i],t,r.concat(a))}n&&this.useBrackets?t[r.join(this.separator).concat("["+i+"]")]=e[i]:t[r.concat(a).join(this.separator)]=e[i]}.bind(this)),t},K.pick=P("pick"),K.move=P("move"),K.transfer=P("transfer"),K.transform=P("transform"),K.copy=P("copy"),K.object=P("object"),K.str=P("str"),K.set=P("set"),K.delete=P("delete"),K.del=K.remove=P("remove"),K.dot=P("dot"),["override","overwrite"].forEach((function(e){Object.defineProperty(K,e,{get:function(){return D.override},set:function(e){D.override=!!e}})})),["useArray","keepArray","useBrackets"].forEach((function(e){Object.defineProperty(K,e,{get:function(){return D[e]},set:function(t){D[e]=t}})})),K._process=j;var C=K;const R={tester:a(3,o(s("SourceTable"))),renderer:n((({data:t})=>{const n=r((()=>C.dot(t)),[t]);return e.createElement("div",{style:{width:"1100px",margin:"0 auto"}},e.createElement("h2",{style:{width:"max-content"}},"Source Data"),e.createElement(f,{component:h},e.createElement(m,null,e.createElement(d,null,e.createElement(v,null,Object.keys(n).map((t=>e.createElement(g,{style:{fontWeight:600},key:t},t))))),e.createElement(b,null,e.createElement(v,null,Object.keys(n).map((r=>e.createElement(g,{key:r},C.pick(r,t)))))))))}))},J=e=>{const t=[];return Object.keys(C.dot(e.properties)).forEach((r=>{const n=(e=>{const t=e.replaceAll("properties.","").split(".");return t.slice(0,t.length-1).join(".")})(r),i=r.split("."),a=i.slice(0,i.length-1).join("."),o=C.pick(a,e.properties),s={value:n,...o};t.find((e=>e.value===n))||t.push(s)})),t},N=(e,t)=>{let r=null;return Object.keys(C.dot(e)).forEach((n=>{if(n.includes("type")&&C.pick(n,e)===t){const t=n.replace("type","scope"),i=C.pick(t,e).split("/"),a=i[i.length-1];r=a}})),r},$=e=>{if(e.baseKeys.dynamicObjectKey)return e[e.baseKeys.dynamicObjectKey].reduce(((e,{source:t,target:r})=>r?.value?(e[t.value]=r.value,e):e),{})},I=(e,t)=>{const r=$(e);return C.transform(C.dot(r),t)};var W=Object.freeze({__proto__:null,getKeyByUiSchemaType:N,createSchema:({source:e,target:t,uischema:r,dataToTransform:n})=>{const i=N(r,"Dynamic"),a=N(r,"SourceTable"),o=N(r,"TransformedTable"),s=J(e),c=J(t);return{schema:{type:"object",properties:{[i]:{type:"array",items:{type:"object",required:["target"],properties:{source:{type:"object",title:e?.title,enum:s},target:{type:"object",title:t?.title,enum:c}}}},...a&&{[a]:{type:"object"}},...o&&{[o]:{type:"object"}}}},data:{[i]:s.map((e=>({source:e}))),[a]:n,[o]:n,baseKeys:{dynamicObjectKey:i}}}},createRecipe:$,transformData:I});const q={tester:a(3,o(s("TransformedTable"))),renderer:n((({data:t})=>{const n=i(),a=r((()=>I(n.core.data,t)||[]),[n.core.data,t]);return e.createElement("div",{style:{width:"1100px",margin:"0 auto"}},Object.keys(a||[]).length>0&&e.createElement(e.Fragment,null,e.createElement("h2",{style:{width:"max-content"}},"Transformed Data"),e.createElement(f,{component:h},e.createElement(m,null,e.createElement(d,null,e.createElement(v,null,Object.keys(C.dot(a)).map((t=>e.createElement(g,{style:{fontWeight:600},key:t},t))))),e.createElement(b,null,e.createElement(v,null,Object.keys(C.dot(a)).map((t=>e.createElement(g,{key:t},JSON.stringify(C.pick(t,a)))))))))))}))};export{E as MappingRendererControl,R as SourceTableControl,q as TransformedTableControl,W as sdk};
